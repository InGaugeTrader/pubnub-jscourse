<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

	<title>JS Webinar Chat</title>
	<meta name="description" content="JS Webinar Chat">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link href='http://fonts.googleapis.com/css?family=Gorditas:700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="bootstrap/css/bootstrap.min.css" >
	<link rel="stylesheet" href="css/style.css">
</head>

<body >

	<div class="modal fade" id="profile-modal">
  		<div class="modal-dialog">
    		<div class="modal-content">
      				<div class="modal-header">
        				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        				<h4 class="modal-title">Welcome, please log in or click on register</h4>
      				</div>
      				<div class="modal-body">
      				  <div class="row">
      				  	<div class="col-sm-12 form-group">
      				  		<label for="txtUsername">User Name:</label>
        					<input type="text" id="username" class="form-control">
        			 	</div>
        			  </div>
        			  <div class="row">
        			  	<div class="col-sm-12 form-group">
        			  		<label for="txtLocation"><p>Password</p></label>
        			  		<input type="password" id="password" class="form-control">
        			  	</div>
        			  </div>
      				</div>
      				<div class="modal-footer">
        				<button type="button" class="btn btn-default" data-dismiss="modal" id="btn-register">Register</button>
        				<button type="button" class="btn btn-primary" data-dismiss="modal" id="btn-login">Login</button>
      				</div>
      				
    		</div><!-- /.modal-content -->	
  		</div><!-- /.modal-dialog -->
	</div><!-- /.modal -->

	<div class="modal fade" id="register-profile-modal">
  		<div class="modal-dialog">
    		<div class="modal-content">
      				<div class="modal-header">
        				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        				<h4 class="modal-title">Create a new account</h4>
      				</div>
      				<div class="modal-body">
      				  <div class="row">
      				  	<div class="col-sm-12 form-group">
      				  		<label for="firstname">First Name: </label>
        					<input type="text" class="form-control" id="firstname">
        			 	</div>
        			  </div>
        			  <div class="row">
      				  	<div class="col-sm-12 form-group">
      				  		<label for="firstname">Last Name: </label>
        					<input type="text" class="form-control" id="lastname">
        			 	</div>
        			  </div>
        			  <div class="row">
      				  	<div class="col-sm-12 form-group">
      				  		<label for="firstname">Email: </label>
        					<input type="text" class="form-control" id="emaila">
        			 	</div>
        			  </div>
        			  <div class="row">
      				  	<div class="col-sm-12 form-group">
      				  		<label for="firstname">username: </label>
        					<input type="text" class="form-control" id="username">
        			 	</div>
        			  </div>
        			  <div class="row">
      				  	<div class="col-sm-12 form-group">
      				  		<label for="firstname">password: </label>
        					<input type="password" class="form-control" id="password">
        			 	</div>
        			  </div>
        			  <div class="row">
      				  	<div class="col-sm-12 form-group">
      				  		<label for="firstname">password (re-type): </label>
        					<input type="password"  class="form-control" id="password">
        			 	</div>
        			  </div>
      				</div>
      				<div class="modal-footer">
        				<button type="button" class="btn btn-default" data-dismiss="modal" id="btn-save-register">Register</button>
        				<button type="button" class="btn btn-primary" data-dismiss="modal" id="btn-cancel">Cancel</button>
      				</div>
      			
    		</div><!-- /.modal-content -->	
  		</div><!-- /.modal-dialog -->
	</div><!-- /.modal -->


	

	<section id="main" role="main">
		
		<div  class="container">

		  <div class="row">
		  	<div class="col-lg-12 well well-lg" style="background-color: #708090">

			<div class="row">
				<div class="col-sm-12">
					
							<button type="button" class="btn btn-default btn-sm" style="position: relative; top: -5px;left:12px; float:right" id="register-button" data-toggle="modal" data-target="#register-profile-modal">
  								<span class="glyphicon glyphicon-th" aria-hidden="true"></span>
							</button>


							<button type="button" class="btn btn-default btn-sm" style="position: relative; top: -5px;left:12px; float:right" id="login-button" data-toggle="modal" data-target="#profile-modal">
  								<span class="glyphicon glyphicon-user" aria-hidden="true"></span>
							</button>
					
			   </div>
			</div> 
			
			<div class="row" >
				
				<div  class="col-md-4" style="position: relative;left: -3px;display:block">
					<div class="row">
						<div id="user-count-container" class="well col-sm-12">
			 				<p id="presence"><span class="badge"></span></p>
			 			</div>
			 		</div>
			 		<div class="row">
			 			<div  class="well col-sm-12" style="height:546px;padding: 18px">
			 				<ul id="userl" class="list-group">
			 				</ul>
			 			</div>
			 		</div>
				</div>

				<div  class="col-md-8" id="message-area">
					

					<div class="row well">
						<div id="chat-output" class="col-sm-12">
							<ul id="chat-messages" class="list-group">
							</ul>
						</div>
					</div>
					<div class="row well">
						<div id="chat-control" class="col-sm-8">
							<div class="message-console-send-area" class="col-sm-10">
                            	<label class="message-console-textarea-title" for="message-console-input">message</label>
                            	<textarea class="console-message" id="console-message-input" placeholder="Your message....."></textarea>
                        	</div>
                        	<div class="col-sm-4">
                        		<button type="button" class="btn btn-default btn-lg" id="send-button">
  									<span class="glyphicon glyphicon-envelope" aria-hidden="true"></span> Send
								</button>
							</div>
                    	</div>
					</div>
				</div>
		    </div>

		    </div>
		    </div>

	</section>

	<footer></footer>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
	<script src="bootstrap/js/bootstrap.js" ></script>
	<script src="http://cdn.pubnub.com/pubnub-3.7.11.js"></script>
	<script src="js/app.js"></script>
	<script>
	   (function(){

	   		//Init & Subscribe
	   		//var API_SERVER_BASE = "http://localhost:5000/chatterbox"
	   		var API_SERVER_BASE = "http://agile-atoll-1850.herokuapp.com/chatterbox"
	   		var chat_channel = "webinar-chat";
	   		var subkey = "sub-c-8bd55596-1f48-11e5-9205-0619f8945a4f";
	   		var pubkey = "pub-c-27c05fcb-d215-4433-9b95-a6e3fd9f49d7";
			var avatarClassName = 'face-' + ((Math.random() * 13 + 1) >>> 0) + ' color-' + ((Math.random() * 10 + 1) >>> 0);
	   		var profile = null;
	   		var pubnub = null;
			var lastTimeToken = localStorage.getItem(subkey);

	   		var initialize_pubnub = function(profile){
	   		
	   			pubnub = PUBNUB.init({
	   				subscribe_key: subkey,
	   				publish_key: pubkey,
	   				uuid: profile.username,
	   				auth_key: profile._id
	   				//ssl: true,
	   				//windowing: 
	   				//cipher_key: ''
	   			});	


	   			pubnub.subscribe({channel: chat_channel,
	   						  restore: true, //attempt to restore missing messages on reconnect
	   						  timetoken: lastTimeToken,
	   						  connect: function(res){
	   						 	 console.log('connected');

	   						 	 pubnub.history({
	   						 	 	channel: chat_channel,
	   						 	 	start: lastTimeToken,
	   						 	 	count: 50,
	   						 	 	include_token: true,
	   						 	 	callback: function(m){
	   						 	 		console.log('got history:');
	   						 	 		m[0].forEach(function(e){ //First element is the history, last 2 are timestamps
	   						 	 			if(typeof e === 'object'){
	   						 	 				var msg = e.message;
	   						 	 				var tt = e.timetoken;
	   						 	 				
	   						 	 				UI.addChatMessage(msg.text,UI.formatTimeToken(tt),msg.from,msg.avatar);
	   						 	 			}
	   						 	 		})
	   						 	 	}
	   						 	 })


	   						  },
	   						  disconnect: function(res){
	   						  		//called when pubnub sdk is disconnected from the pubnub 
	   						  		console.log('disconnect called');
	   						  },

	   						  reconnect: function(res){
	   						  		console.log('reconnecting to pubnub');
	   						  },

	   						  callback: function(message,envelope,channel){
	   						  //LAB#1

	   						  		/* called when a message arrives
	   						  	     * parameters are:
	   						  	     * channel: the name of the channel the message arrived on
	   						  	     * envelope: the complete envelope which contains an tuple of {channel_name, message,timetoken}
	   						  	     * message: the message
	   						  	     */
	   						  	    var timeToken = envelope[1];
	   								var formattedTime = UI.formatTimeToken(timeToken);
									var messageText = message.text;
									var fromUser = message.from;
									var avatar = message.avatar;
									UI.addChatMessage(messageText,formattedTime,fromUser,avatar);
	   						  	  
	   						  },
	   						  presence: function(m){
	   						  		//LAB3
	   						  		if(m.action === "state-change"){
            							console.log('state-change event: ');
            							UI.handleStateChange(m.action,m.uuid,m.data);
            						}else if(m.action === "join"){
            							console.log('join event');
            							//get the state of the user
            							pubnub.state({channel: chat_channel,
            										  uuid: m.uuid,
            										  callback: function(s){
            										  	UI.handleStateChange('state-change',m.uuid,s);
            										  }});

            							UI.updateRoomCount(m.action,m.occupancy);
            						}else if((m.action === "timeout") || (m.action === "leave")){
            							console.log('timeout or leave event, remove the user element');
            							UI.handleLeaveEvent(m.action,m.uuid); //Remove the user from the list of participants
            							UI.updateRoomCount(m.action,m.occupancy); //Update the number of users present
            						}
	   						  }
	   				});


					pubnub.state({	channel: chat_channel,
	   							uuid:  profile.username,
	   							state: profile });
			}
			

			//update our state...this will trigger a state-change and should add the user to the occupants lists
			//LAB2.1
	   		function login(){
	   			var txtUserName    = document.querySelector('#username');
	   			var txtPassword    = document.querySelector('#password');
	   			var profile = null;

	   			console.log('username: ' + txtUserName.value + ' password: ' + txtPassword.value);

	   			$.ajax({ url: API_SERVER_BASE + "/cbox/login"
  						 ,data: JSON.stringify({"username": txtUserName.value, "password": txtPassword.value})
  						 ,dataType: "json"
  						 ,processData: false
  						 ,type: "POST"
  						 ,crossDomain: true
  						 ,contentType: 'application/json'
  						 ,error: function(r){
  						 	console.log(r);
  						 }

						}).done(function(results) {
  							console.dir(results);

  							localStorage.setItem('profile',JSON.stringify(results));
  							localStorage.setItem('profileUserName', results.username);
	   						localStorage.setItem('profileLocation', results.location);
	   						
	   						localStorage.setItem('profileAvatarClassName',avatarClassName);
	   						localStorage.setItem('profileExists',true);
	   						initialize_pubnub(results);
	   						logged_in = true;
						});

	   		}

	   		function show_registration(){
	   			$('#register-profile-modal').modal('show');
	   		}

	   		function save_registration(){
	   			console.log('inside save registration');
	   			var firstName   = document.querySelector('#firstname').value;
	   			var lastName    = document.querySelector('#lastname').value;
	   			var email       = document.querySelector('#emaila').value;
	   			var username    = document.querySelector('#username').value;
	   			var password    = document.querySelector('#password').value

	   			
	   			var newProfile = {"firstName": firstName
	   							 ,"lastName": lastName
	   							 ,"email": "dummy@email.com"
	   							 ,"password": password
	   							 ,"username": username
	   							 ,"location": 'unused'
	   							 ,"level": 'gold'};

	   			console.log('sending profile: ' + JSON.stringify(newProfile));


	   			$.ajax({ url: API_SERVER_BASE + "/api/v1/cbox/profile"
  						 ,data: JSON.stringify(newProfile)
  						 ,dataType: "json"
  						 ,processData: false
  						 ,type: "POST"
  						 ,crossDomain: true
  						 ,contentType: 'application/json'
  						 ,error: function(r){
  						 	console.log(r);
  						 }

						}).done(function(results) {
  							console.dir(results);

  							localStorage.setItem('profile',JSON.stringify(results));
  							localStorage.setItem('profileUserName', results.username);
	   						localStorage.setItem('profileLocation', results.location);
	   						
	   						localStorage.setItem('profileAvatarClassName',avatarClassName);
	   						localStorage.setItem('profileExists',true);
	   						initialize_pubnub(results);
	   						logged_in = true;
						});

	   		}

	   		
	   		var login_button = document.querySelector('#btn-login');
	   		var register_button = document.querySelector("#btn-register");
	   		var save_registration_button = document.querySelector('#btn-save-registration');
	   		
	   		login_button.onclick = login;
	   		register_button.onclick = show_registration;
	   		save_registration_button = save_registration;

			
		
	   		/** 
			 * this function publishes the text in the input text to pubnub, anyone subscribed to the channel will recieve 
			 * the message
			 **/
			function publish() {
				//#LAB3
				var messageText = document.querySelector("#console-message-input");
				var profileUserName = localStorage.getItem('profileUserName');
				var profileAvatar = localStorage.getItem('profileAvatarClassName');
				var message = {from: profileUserName, avatar: profileAvatar, text: messageText.value}; //You can add any attributes you want

        		pubnub.publish({
            				channel : chat_channel, 
            				message : message, 
            				callback: function(res){
                					console.log('this callback willl be called when the message is sent');
            			  	},
            				error: function(err){
            					  console.log('an error has occurred while publishing the message');
            				}
        				});

        		messageText.value = ' ';
        	}

        	//reference to the send button element
	   		var messageSend = document.querySelector("#send-button");
	   		messageSend.onclick = publish;

	   		//see if this user is already logged in
	   		if(localStorage.getItem('profile')){
	   			var profileStr = localStorage.getItem('profile');
	   			profile = JSON.parse(profileStr);
	   			initialize_pubnub(profile);
	   			
	   			console.log('attempting to hide buttons');
	   			$('#login-button').hide();
	   			$('#register-button').hide();
	   		}else{
	   			$('#profile-modal').modal('show');
			}
	   		
	   		
	   		lastTimeToken = localStorage.getItem(subkey);
	   		if(lastTimeToken === null){
	   			console.log('not using last token');
	   			lastTimeToken = 0; //make it zero
	   		}


	   })()
	</script>
	
</body>
</html>
